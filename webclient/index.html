<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WhoisOnline Chat</title>

    <link rel="stylesheet" type="text/css" href="css/global.css">
    <link rel="stylesheet" type="text/css" href="css/conversations.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script>

	var toast_timer=false;

	function toast(info)
	{
	    if (toast_timer) clearTimeout(toast_timer);
	    var t=$("div#toast");
	    t.stop().fadeIn(800);
	    t.append(info+"<br>");

	    toast_timer=setTimeout(function () {
		toast_timer=false;
		t.stop().fadeOut(800,function () { t.empty(); });
	    },3000);
	}

	function set_online_status(w)
	{
	    if (w=="online") $(".online_status").addClass("online").removeClass("offline");
	    if (w=="offline") $(".online_status").addClass("offline").removeClass("online");
	}

	function contains(arr,element)
	{
	    var i;
	    for (i=0;i<arr.length;i++)
		if (arr[i]==element) return true;
	    return false;
	}

	var post_api_cmds=["start_conversation"];

	function api(cmd,data,f)
	{
	    var method;
	    if (contains(post_api_cmds,cmd)) method="POST";
	    else method="GET";

	    $.ajax({ 
		type: method,
		url: "/clientapi/"+cmd,
		data: data,
		dataType: "JSON",
		success: function (ret) {
		    if (ret.result==200) 
		    {
	 	        f(ret);
		        set_online_status("online");
		    }
		    else if (ret.result==401)
		    {
		        alert("Server asks for authentication...");
		        window.location="/login";
		    }
			    // else TODO   
		},
	    	fail: function () { set_online_status("offline"); } // fail: server not reachable ?
	    });
	}

	function logout()
	{
	    api("logout",false,function () {
		window.location="/login";
	    });
	}

	function add_omenu_entry(word,func)
	{
	    var entry=$("<button class=menubutton>"+word+"</button>");
	    entry.appendTo("#omenu").click(func);
	}
  
	var search_timer=false;
	var last_search="";

	function delayed_add_dialog_search()
	{
	    if (search_timer) clearTimeout(search_timer);
	    search_timer=setTimeout(function () { search_timer=false; add_dialog_search(); },1000);
	}

	function show_search_result(data)
	{
	    var ul=data.userlist;
	    $("#add_search_result").empty();
	    if (ul) for (var i=0;i<ul.length;i++)
	    {
		if (ul[i].username) $("#add_search_result").append("<li><span>"+ul[i].username+"</span> "+
				      "<i class=\"add_conv_username fa fa-plus-circle\"></i></li>");
	    }
	}

	function add_dialog_search()
	{
	    if (search_timer) clearTimeout(search_timer);
	    search_timer=false;
	    var word=$("#searchword").val();
	    if (word.length<1 || word==last_search) return;
	    last_search=word;
	    api("search_user",{ search: word }, show_search_result);
	}

	function start_conversation(username)
	{
	    if (username.length<5) return;
	    api("start_conversation",{ username: username },function(data) {
                $("#add_conv").show();
                $("#add_conv_dialog").hide();
	    });
	}

	function show_conversation_list(data)
	{
	    var conversations=data.data;
	    if (!conversations) return;
	    $("#convlist").empty();
	    for (var i=0;i<conversations.length;i++)
	    {
		add_conversation(conversations[i].to);
	    }
	}

	var seq=1;

	var error_retry_time_min=1500;
	var error_retry_time_max=10000;
	var error_retry_time=1500;

	function poll_error_retry()
	{
	    set_online_status("offline");
	    setTimeout(poll,error_retry_time);
	    if (error_retry_time<error_retry_time_max) error_retry_time+=500;
	}

	function add_conversation(username)
	{
	    $("#convlist").append("<li>"+username+"</li>");
	}

	function handle_msgs(msgs)
	{
	    for(var i=0;i<msgs.length;i++)
	    {
		var m=msgs[i];
	    	if (m["type"]=="add_conversation")  add_conversation(m["username"]);
	    	else toast("unknwon msg type: "+m["type"]);
	    }
	}

	function poll()
	{
		// didn't use the api() function, because we need different error handling
	    $.getJSON("/clientapi/poll",{ack:seq},function (data) {
		$("#conv_div").text(JSON.stringify(data,null,2));

		if (data.seq) seq=data.seq;
		if (!data.result) { poll_error_retry(); return; }

		if (data.result<400) { set_online_status("online"); error_retry_time=error_retry_time_min; }

		if (data.result==200) { handle_msgs(data.msgs); setTimeout(poll,100); }
		else if (data.result==204) setTimeout(poll,100);
		else if (data.result==503) setTimeout(poll,data.retry_after||2000);
		else if (data.result==401) { alert("Server asks for authentication..."); window.location="/login"; }
		else poll_error_retry();
	    }).fail(poll_error_retry);
	}

	layout_list_minimized=false;

	function layout(mode)
	{
	    if(mode=="smooth")
	    {
	    	if(layout_list_minimized)  
		{
		    $("#convlist_div").animate({left:"-12.3em"});
		    $("#conv_div").animate({left:"1.9em"});
		}
	    	if(!layout_list_minimized) 
		{
		    $("#convlist_div").animate({left:0});
		    $("#conv_div").animate({left:"14.2em"});
		}
	    }
	}

	$(document).ready(function(){
	    api("start",false,function (data) {
		$(".username").text(data.username);
		if(data.now) last_poll=new Date(data.now);
		if(data.seq) seq=data.seq;
		$(".now").text(last_poll.toLocaleTimeString());
		api("get_conversations",false,show_conversation_list);
	    });
	    $("#omenu").hide();
	    $(".option-menu").click(function () { $("#omenu").toggle(); });
	    $("#add_conv").click(function () {
		$("#add_conv").hide();
		$("#add_conv_dialog").show();
	    });
	    $("#close_search").click(function () {
		$("#add_conv").show();
		$("#add_conv_dialog").hide();
	    });
	    $("#searchword").change(delayed_add_dialog_search).keypress(delayed_add_dialog_search);
	    $("#do_search").click(add_dialog_search);
	    $('#add_search_result').on('click','.add_conv_username', function (event) {
                start_conversation($(event.target).parent().find("span").text());
            });
	    $("#list_size_handle").click(function () {
		layout_list_minimized=!layout_list_minimized;
		$("#list_size_handle").toggleClass("fa-arrow-circle-left fa-arrow-circle-right");
		layout("smooth");
	    });
	    add_omenu_entry("Logout",logout);
	    setTimeout(poll,100);
	});
    </script>
</head>
<body>
<div id=convlist_div>
    <div id=add_conv_dialog>
	Search for user address:<br>
	<input id=searchword> 
	<i id="do_search" class="fa fa-search"></i>
	<i id="close_search" class="fa fa-times"></i>
	<ul id=add_search_result>
	</ul>
    </div>
    <ul id=convlist>
	<li>Loading...<i class="fa fa-circle-o-notch fa-spin"></i></li>
    </ul>
    <i id=add_conv class="fa fa-plus-circle"></i>
    <i id=list_size_handle class="fa fa-arrow-circle-left"></i>
</div>
<div id=conv_div>
    Select a conversation int the conversation list.
</div>
<div id=header>
    <h1 class=logo>WhoisOnline <i class="online_status fa fa-at"></i> </h1>
    <div id=status>
	<i class="option-menu fa fa-bars"></i>
	<div class=now></div>
	<div class=username></div>
    </div>
</div>
<div id=omenu>
</div>
<div id=toast>
</div>
</body>
</html>
